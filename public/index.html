<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AMFE‚ÄëFMEA de Proceso</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <header>
    <!-- Eliminamos la palabra ‚ÄúPreliminar‚Äù para reflejar que este formato puede utilizarse en cualquier etapa del AMFE -->
    <h1>AMFE‚ÄëFMEA de Proceso</h1>
    <nav>
      <!-- Enlace para volver al inicio, donde se listan los AMFEs guardados -->
      <a href="home.html" class="btn-primary">Inicio</a>
    </nav>
  </header>
  <!-- Datos generales del an√°lisis (Paso 1: planificaci√≥n y preparaci√≥n) -->
  <section id="general-info" class="collapsible-section">
    <h2 class="collapsible-header" onclick="toggleSection('general-info-content')">
      <span class="collapse-icon">‚ñº</span>
      Datos generales
    </h2>
    <div id="general-info-content" class="collapsible-content">
    <div class="grid-3">
      <label>Nombre de la organizaci√≥n:<br>
        <input type="text" id="orgName" value="" required>
      </label>
      <label>Tema:<br>
        <input type="text" id="tema" value="" required>
      </label>
      <label>N¬∫ de AMFE:<br>
        <input type="text" id="numeroAmfe" required>
      </label>
      <label>Revisi√≥n AMFE:<br>
        <input type="text" id="revisionAmfe" required>
      </label>
      <label>Ubicaci√≥n de la planta:<br>
        <input type="text" id="planta" value="" required>
      </label>
      <label>Fecha inicio AMFE:<br>
        <input type="date" id="fechaInicio" required>
      </label>
      <label>Responsable del proceso:<br>
        <input type="text" id="responsable" value="" required>
      </label>
      <label>Nombre del cliente:<br>
        <input type="text" id="cliente" value="" required>
      </label>
      <label>Fecha revisi√≥n AMFE:<br>
        <input type="date" id="fechaRevision" required>
      </label>
      <label>Nivel de confidencialidad:<br>
        <input type="text" id="confidencialidad" value="" required>
      </label>
      <label>Modelo-a√±o plataforma:<br>
        <input type="text" id="modelo" value="" required>
      </label>

      <!-- Equipo multifuncional -->
      <label>Equipo multifuncional:<br>
        <input type="text" id="equipo" value="" required placeholder="Lista de integrantes">
      </label>

      <!-- N√∫mero del plan de control -->
      <label>N¬∫ de plan de control:<br>
        <input type="text" id="planNumber" required>
      </label>

      <!-- Contacto clave / Tel√©fono -->
      <label>Contacto clave / Tel√©fono:<br>
        <input type="text" id="contacto" required>
      </label>

      <!-- Tipo de plan (Prototipo, Prelanzamiento, Producci√≥n, Lanzamiento Seguro) -->
      <label>Tipo de plan:<br>
        <select id="tipoPlan" required>
          <option value="">Seleccione‚Ä¶</option>
          <option value="Prototipo">Prototipo</option>
          <option value="Prelanzamiento">Prelanzamiento</option>
          <option value="Producci√≥n">Producci√≥n</option>
          <option value="Lanzamiento Seguro">Lanzamiento Seguro</option>
        </select>
      </label>

      <!-- N√∫mero de parte (sistema/subsistema/componente) -->
      <label>N¬∫ de parte:<br>
        <input type="text" id="numParte" required>
      </label>

      <!-- √öltimo cambio de ingenier√≠a -->
      <label>√öltimo nivel de cambio de ingenier√≠a:<br>
        <input type="text" id="ultimoCambio" required>
      </label>

      <!-- Aprobaci√≥n proveedor/planta -->
      <label>Aprobaci√≥n proveedor/planta:<br>
        <input type="date" id="aprobProv" required>
      </label>

      <!-- Aprobaci√≥n ingenier√≠a cliente -->
      <label>Aprobaci√≥n ingenier√≠a cliente:<br>
        <input type="date" id="aprobIngCliente" required>
      </label>

      <!-- Aprobaci√≥n calidad cliente -->
      <label>Aprobaci√≥n calidad cliente:<br>
        <input type="date" id="aprobCalidadCliente" required>
      </label>

      <!-- Otras aprobaciones -->
      <label>Otras aprobaciones:<br>
        <input type="text" id="aprobOtras" placeholder="Descripci√≥n / fecha">
      </label>
      <!-- Aprobaci√≥n de seguridad para caracter√≠sticas cr√≠ticas -->
      <div id="safety-approval-container" style="display:none; align-items:center; background-color:#fff0f0; padding:10px; border-radius:4px; grid-column: 1 / -1;">
        <input type="checkbox" id="safetyApproval" style="width:auto; margin-right:10px;">
        <label for="safetyApproval" style="margin-bottom:0; color:#c0392b; font-weight:bold;">Aprobaci√≥n de Seguridad Requerida (Severidad Cr√≠tica Detectada)</label>
      </div>
    </div>
    </div>
  </section>
  <nav id="main-nav">
    <button id="tab-fmea" class="tab-btn active">AMFE</button>
    <button id="tab-control" class="tab-btn">Plan de control</button>
    <button id="tab-standard" class="tab-btn">Vista est√°ndar</button>
    <button id="tab-instructions" class="tab-btn">Instrucciones de Proceso</button>
    <button id="tab-iatf" class="tab-btn">Gesti√≥n IATF 16949</button>
  </nav>
  <!-- Resumen de errores de validaci√≥n -->
  <div id="error-summary" class="error-summary" style="color:#b00020; font-weight:bold; margin:8px 0;"></div>
  
  <!-- Progress summary card -->
  <div id="progress-summary" class="progress-card">
    <div class="progress-item">
      <span class="progress-icon">üìù</span>
      <span class="progress-label">√çtems</span>
      <span class="progress-value" id="progress-items">0</span>
    </div>
    <div class="progress-item">
      <span class="progress-icon">‚öôÔ∏è</span>
      <span class="progress-label">Elementos</span>
      <span class="progress-value" id="progress-elements">0</span>
    </div>
    <div class="progress-item">
      <span class="progress-icon">‚ö†Ô∏è</span>
      <span class="progress-label">Riesgos Cr√≠ticos</span>
      <span class="progress-value critical" id="progress-critical">0</span>
    </div>
    <div class="progress-item">
      <span class="progress-icon">‚úÖ</span>
      <span class="progress-label">Completado</span>
      <span class="progress-value" id="progress-completion">0%</span>
    </div>
  </div>
  
  <main>
    <!-- Secci√≥n AMFE con estructura y detalle -->
    <section id="fmea-section" class="tab-content active">
      <div id="structure-and-detail">
        <!-- Panel de estructura (Paso 2) -->
        <aside id="structure-panel">
          <h3>Estructura (Paso&nbsp;2)</h3>
          <ul id="item-list" class="tree"></ul>
          <button id="add-item">+ √çtem</button>
        </aside>
        <!-- Panel de detalle: pasos 3, 4, 5, 6 -->
        <section id="detail-panel">
          <h3 id="detail-title">Detalle</h3>
          <div id="detail-tabs" class="subtabs">
            <button class="detail-tab active" data-tab="funciones">Funciones (Paso&nbsp;3)</button>
            <button class="detail-tab" data-tab="fallas">Fallos (Paso&nbsp;4)</button>
            <button class="detail-tab" data-tab="riesgos">Riesgos (Paso&nbsp;5)</button>
            <button class="detail-tab" data-tab="optimizacion">Optimizaci√≥n (Paso&nbsp;6)</button>
          </div>
          <div id="detail-content">
            <!-- Contenidos de cada sub-tab -->
            <div class="detail-tab-content active" id="tab-funciones">
              <form id="funciones-form">
                <div class="grid-3">
                  <label>Funci√≥n del √≠tem (sistema/subsistema/proceso):<br>
                    <textarea id="funcionItem"></textarea>
                  </label>
                  <label>Funci√≥n del paso del proceso (caracter√≠stica del producto):<br>
                    <textarea id="funcionPaso"></textarea>
                  </label>
                  <label>Funci√≥n del elemento de trabajo (caracter√≠stica del proceso):<br>
                    <textarea id="funcionElemento"></textarea>
                  </label>
                </div>
              </form>
            </div>
            <div class="detail-tab-content" id="tab-fallas">
              <div class="fallas-header">
                <h4>Modos de falla</h4>
                <button id="add-falla">+ Modo de Falla</button>
              </div>
              <table id="fallas-table">
                <thead>
                  <tr>
                    <th>Efecto de la falla (EF)</th>
                    <th>Modo de falla (FM)</th>
                    <th>Causa de la falla (FC)</th>
                    <th>Controles preventivos actuales</th>
                    <th>Controles detectivos actuales</th>
                  </tr>
                </thead>
                <tbody id="fallas-body">
                </tbody>
              </table>
            </div>
            <div class="detail-tab-content" id="tab-riesgos">
              <div class="grid-3">
                <label>Severidad (S):<br>
                  <select id="severidad"></select>
                </label>
                <label>Ocurrencia (O):<br>
                  <select id="ocurrencia"></select>
                </label>
                <label>Detecci√≥n (D):<br>
                  <select id="deteccion"></select>
                </label>
              </div>
              <div>
                <strong>Prioridad de acci√≥n (AP):</strong> <span id="ap-display" class="ap-cell"></span>
              </div>
              <label>Caracter√≠sticas especiales:<br>
                <input type="text" id="caracteristicas">
              </label>

              <!-- Caja plegable para gu√≠as de detecci√≥n y clasificaci√≥n.  Utilizamos un elemento
                   <details> para permitir mostrar u ocultar las gu√≠as sin necesidad de
                   JavaScript.  El usuario puede hacer clic en el texto del resumen para
                   desplegar o contraer las gu√≠as. -->
              <details id="guidelines-box" open style="margin-top:8px;">
                <summary id="toggle-guidelines" style="cursor:pointer;font-weight:bold;color:#004080;">
                  Ocultar/Mostrar gu√≠as
                </summary>
                <div class="guidelines">
                  <h4>Gu√≠as de detecci√≥n (D)</h4>
                  <ul>
                    <li><strong>D=1</strong>: Poka‚Äëyoke 100‚ÄØ% preventivo ‚Äì el modo de falla no puede producirse ni procesarse.</li>
                    <li><strong>D=2</strong>: Poka‚Äëyoke detectivo 100‚ÄØ% en estaci√≥n ‚Äì detiene el proceso si ocurre la falla.</li>
                    <li><strong>D=3</strong>: Detecci√≥n autom√°tica en estaci√≥n (poka‚Äëyoke detectivo) que detiene la l√≠nea si se detecta la falla.</li>
                    <li><strong>D=4</strong>: Detecci√≥n autom√°tica post‚Äëproceso (fuera de la estaci√≥n principal).</li>
                    <li><strong>D=5</strong>: Verificaci√≥n autom√°tica en l√≠nea (sin poka‚Äëyoke) o por muestreo con R&R aceptable.</li>
                    <li><strong>D=6</strong>: Inspecci√≥n visual o medici√≥n manual por muestreo/post‚Äëproceso con R&R aprobado.</li>
                  </ul>
                  <h4>Clasificaci√≥n de caracter√≠sticas especiales</h4>
                  <ul>
                    <li><strong>Cr√≠tica</strong>: Severidad ‚â•‚ÄØ9 (riesgo de seguridad, funcionalidad o incumplimiento normativo).</li>
                    <li><strong>Significativa</strong>: Severidad de 5 a 8 y ocurrencia ‚â•‚ÄØ4 (alto impacto o caracter√≠sticas importantes).</li>
                  </ul>
                </div>
              </details>
            </div>
            <div class="detail-tab-content" id="tab-optimizacion">
              <h4>Acciones y seguimiento</h4>
              <div class="grid-2">
                <label>Acci√≥n preventiva:<br>
                  <input type="text" id="accionPrev">
                </label>
                <label>Acci√≥n detectiva:<br>
                  <input type="text" id="accionDet">
                </label>
                <label>Nombre responsable:<br>
                  <input type="text" id="personaResp">
                </label>
                <label>Fecha objetivo de terminaci√≥n:<br>
                  <input type="date" id="fechaObjetivo">
                </label>
                <label>Estatus:<br>
                  <select id="estatus">
                    <option value="">Seleccione‚Ä¶</option>
                    <option value="Abierto">Abierto</option>
                    <option value="Implementaci√≥n pendiente">Implementaci√≥n pendiente</option>
                    <option value="Decisi√≥n pendiente">Decisi√≥n pendiente</option>
                    <option value="Completa">Completa</option>
                    <option value="No implementado">No implementado</option>
                  </select>
                </label>
                <label>Acci√≥n tomada:<br>
                  <input type="text" id="accionTomada">
                </label>
                <label>Fecha de terminaci√≥n:<br>
                  <input type="date" id="fechaTerminacion">
                </label>
                <label>Severidad (post):<br>
                  <select id="sPost"></select>
                </label>
                <label>Ocurrencia (post):<br>
                  <select id="oPost"></select>
                </label>
                <label>Detecci√≥n (post):<br>
                  <select id="dPost"></select>
                </label>
                <label>Caracter√≠sticas especiales (post):<br>
                  <input type="text" id="caracteristicasPost">
                </label>
                <label>Prioridad de acci√≥n post:<br>
                  <span id="ap-post-display" class="ap-cell"></span>
                </label>
                <label>Observaciones:<br>
                  <textarea id="observaciones"></textarea>
                </label>
              </div>
            </div>
          </div>
        </section>
      </div>
      <div class="actions" style="display: flex; justify-content: space-between; align-items: center;">
        <div>
          <button id="save-btn">Guardar AMFE</button>
          <button id="export-btn">Exportar a Excel</button>
          <a href="lessons.html" id="lessons-learned-btn" class="btn">Lecciones Aprendidas</a>
          <button id="history-btn">Historial de Cambios</button>
        </div>
        <span id="save-status" style="margin-left: 10px;"></span>
      </div>
    </section>

    <!-- Modal para el historial de cambios -->
    <div id="history-modal" class="modal" style="display:none;">
      <div class="modal-content">
        <span class="close-btn">&times;</span>
        <h2>Historial de Cambios</h2>
        <ul id="history-list"></ul>
      </div>
    </div>
    <!-- Secci√≥n plan de control -->
    <section id="control-section" class="tab-content">
    <div class="collapsible-section">
      <h2 class="collapsible-header" onclick="toggleSection('control-header-content')">
        <span class="collapse-icon">‚ñº</span>
        Datos del Plan de Control
      </h2>
      <div id="control-header-content" class="collapsible-content collapsed">
    <!-- Cabecera del plan de control seg√∫n el formato est√°ndar -->
    <div id="control-header" class="grid-4" style="margin-bottom:8px;">
      <label>Fase:<br>
        <select id="cpPhase">
          <option value="">Seleccione‚Ä¶</option>
          <option value="Prototipo">Prototipo</option>
          <option value="Prelanzamiento">Prelanzamiento</option>
          <option value="Producci√≥n">Producci√≥n</option>
        </select>
      </label>
      <label>N¬∫ plan de control:<br>
        <input type="text" id="cpNumber">
      </label>
      <label>Contacto principal / Tel√©fono:<br>
        <input type="text" id="cpContact">
      </label>
      <label>Fecha (original):<br>
        <input type="date" id="cpDateOriginal">
      </label>
      <label>Fecha (revisi√≥n):<br>
        <input type="date" id="cpDateRevision">
      </label>
      <label>N¬∫ de parte / √öltimo cambio:<br>
        <input type="text" id="cpPartNumber">
      </label>
      <label>Equipo principal:<br>
        <input type="text" id="cpMainTeam">
      </label>
      <label>Nombre / Descripci√≥n de la parte:<br>
        <input type="text" id="cpPartDescription">
      </label>
      <label>Proveedor / Planta:<br>
        <input type="text" id="cpSupplierPlant">
      </label>
      <label>C√≥digo de proveedor:<br>
        <input type="text" id="cpSupplierCode">
      </label>
      <label>Aprobaci√≥n proveedor / Fecha:<br>
        <input type="date" id="cpApprovalSupplier">
      </label>
      <label>Aprobaci√≥n t√©cnica cliente / Fecha:<br>
        <input type="date" id="cpApprovalTechClient">
      </label>
      <label>Aprobaci√≥n calidad cliente / Fecha:<br>
        <input type="date" id="cpApprovalQualityClient">
      </label>
      <label>Otra aprobaci√≥n / Fecha:<br>
        <input type="date" id="cpApprovalOther">
      </label>
    </div>
      </div>
    </div>
    
    <h2 style="margin-top: 2rem;">Tabla del Plan de Control</h2>
      <table id="control-table" class="control-standard">
        <thead>
          <tr>
            <th>N¬∫ proceso / Parte</th>
            <th>Nombre de proceso</th>
            <th>M√°quina, utillaje, herramientas</th>
            <th>N¬∫ caracter√≠stica</th>
            <th>Producto</th>
            <th>Proceso</th>
            <th>Clase especial</th>
            <th>Especificaci√≥n / Tolerancia (producto/proceso)</th>
            <th>T√©cnica de medici√≥n</th>
            <th>Error proofing</th>
            <th>M√©todo de Verificaci√≥n de Efectividad</th>
            <th>Frecuencia de Verificaci√≥n</th>
            <th>Muestra ‚Äì Cantidad</th>
            <th>Muestra ‚Äì Frecuencia</th>
            <th>M√©todo de control</th>
            <th>Plan de reacci√≥n</th>
          </tr>
        </thead>
        <tbody id="control-body"></tbody>
      </table>
    </section>
    <!-- Secci√≥n de Vista est√°ndar (formato AIAG-VDA) -->
    <section id="standard-section" class="tab-content">
      <h2>Vista est√°ndar del AMFE (AIAG‚ÄëVDA)</h2>
      <p>A continuaci√≥n se muestra el AMFE en el formato tabular est√°ndar. Puede exportarse a PDF para imprimir o compartir.</p>
      <div id="standard-table-container" style="overflow-x:auto; border:1px solid #ccc; margin-bottom:8px;">
        <!-- La tabla se generar√° din√°micamente mediante script.js -->
      </div>
      <button id="export-standard" class="btn">Exportar vista a PDF</button>
    </section>
    <!-- Secci√≥n de Instrucciones de Proceso -->
    <section id="instructions-section" class="tab-content">
      <h2>Instrucciones de Proceso / Trabajo</h2>
      <p>A continuaci√≥n se muestran las instrucciones de trabajo generadas a partir del AMFE. Puede exportarlas a PDF.</p>
      <div id="instructions-container" style="border:1px solid #ccc; padding:10px; margin-bottom:8px;">
        <!-- Las instrucciones se generar√°n din√°micamente aqu√≠ -->
      </div>
      <button id="export-instructions" class="btn">Exportar Instrucciones a PDF</button>
    </section>
    <!-- Secci√≥n de Gesti√≥n IATF 16949 -->
    <section id="iatf-section" class="tab-content">
      <h2>Gesti√≥n de Cumplimiento IATF 16949</h2>
      
      <!-- Subsecci√≥n: Controles Temporales -->
      <div class="iatf-subsection">
        <h3>1. Gesti√≥n de Controles Temporales (IATF 8.5.6.1.1)</h3>
        <p>Gesti√≥n de desviaciones temporales de controles principales del proceso.</p>
        
        <div id="temporary-controls-active-warning" style="display:none; background:#fff3cd; border:2px solid #ffc107; padding:15px; margin:10px 0; border-radius:5px;">
          <h4 style="color:#856404; margin-top:0;">‚ö†Ô∏è CONTROLES TEMPORALES ACTIVOS</h4>
          <div id="active-controls-list"></div>
        </div>
        
        <table class="iatf-table">
          <thead>
            <tr>
              <th>Proceso/Paso</th>
              <th>Elemento</th>
              <th>Control Principal</th>
              <th>Control Alternativo</th>
              <th>Estado</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="temporary-controls-body"></tbody>
        </table>
      </div>

      <!-- Subsecci√≥n: Pass-Through Characteristics -->
      <div class="iatf-subsection">
        <h3>2. Gesti√≥n de Riesgos de Cadena de Suministro</h3>
        <p>Identificaci√≥n y control de Pass-Through Characteristics (PTCs) y gesti√≥n de proveedores.</p>
        
        <table class="iatf-table">
          <thead>
            <tr>
              <th>Proceso/Paso</th>
              <th>Elemento</th>
              <th>Es PTC</th>
              <th>Proveedor</th>
              <th>PFMEA Proveedor</th>
              <th>√öltima Auditor√≠a</th>
              <th>Estado</th>
              <th>Control en Fabricaci√≥n</th>
            </tr>
          </thead>
          <tbody id="supply-chain-body"></tbody>
        </table>
      </div>

      <!-- Subsecci√≥n: Escalaci√≥n de Riesgos -->
      <div class="iatf-subsection">
        <h3>3. Proceso de Escalaci√≥n de Riesgos</h3>
        <p>Registro y seguimiento de modos de fallo que requieren escalaci√≥n a la direcci√≥n.</p>
        
        <div id="escalation-alerts" style="background:#ffebee; border:2px solid #f44336; padding:15px; margin:10px 0; border-radius:5px; display:none;">
          <h4 style="color:#c62828; margin-top:0;">üö® ALERTAS DE ESCALACI√ìN</h4>
          <div id="escalation-alerts-list"></div>
        </div>
        
        <table class="iatf-table">
          <thead>
            <tr>
              <th>Proceso/Paso</th>
              <th>Elemento</th>
              <th>Severidad</th>
              <th>Modo de Fallo</th>
              <th>Requiere Escalaci√≥n</th>
              <th>Escalado A</th>
              <th>Fecha</th>
              <th>Estado</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="escalation-body"></tbody>
        </table>
      </div>
    </section>
  </main>
  
  <!-- Quick actions floating bar -->
  <div id="quick-actions">
    <button class="btn btn-primary" onclick="document.getElementById('save-btn').click()" title="Guardar AMFE">
      üíæ Guardar
    </button>
    <button class="btn btn-secondary" onclick="scrollToTop()" title="Volver arriba">
      ‚¨ÜÔ∏è Arriba
    </button>
  </div>
  
  <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
  <!-- Librer√≠as para exportar la vista est√°ndar a PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- Firebase SDK (v8 for compatibility with existing code) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="firebase-config.js"></script>
  <script src="script.js"></script>
</body>
</html>